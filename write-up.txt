Introduction

At the beginning I considered two solutions:
-Implement it as a state machine
-Cost-based trajectory selection

Finally I decided to implement a state machine. The related code is located in the PathPlanner class.

Architecture

States

The state machine has 4 different states:
-FollowLane
-FollowLeadingVehicle
-ChangeLaneToLeft
-ChangeLaneToRight

Transitions between the states:

From FollowLane:
The state machine changes from FollowLane to FollowLeadingVehicle, if the distance of the next traffic vehicle in ego lane and ego vehicle is below a critical distance, which is currently 30 meter and the velocity of the this traffic vehicle is slower than the ego velocity.

From FollowLeadingVehicle:
-If lane change to left is possible, the state is changing to ChangeLaneToLeft
-If lane change to right is possible, the state is changing to ChangeLaneToRight
*change lane is possible means that in the target lane there's at least 35 meters to the next vehicle and 15 meter from the previous vehicle and the ego velocity is at least 30 mph and there's a valid driving lane on the requested side.
-It changes to FollowLane if there's no leading vehicle anymore or if the distance to the leading vehicle is more than 30 meter or the velocity of the leading vehicle is higher than the ego velocity+2.

From ChangeLaneToLeft:
-If lane change has been completed (host lane changed) it changes back to FollowLane

From ChangeLaneToRight:
-If lane change has been completed (host lane changed) it changes back to FollowLane

Behavior in different states:

FollowLane:
If the current target velocity (used to setup the previous trajectory) is smaller than 49.5 - Max Acceleration, then the target velocity shall be increased by Max Acceleration.
Then the trajectory is generated by a spline using the previous path points and adding 3 more points to 30, 60 and 90 meters, all three new points located in the ego lane.

FollowLeadingVehicle:
It is using the same way to generate the trajectory, the only difference is the target velocity. The target velocity is calculated in the following way:
If the velocity of the target vehicle is smaller than the current target velocity, or the distance to it is less than 20 meter then the target velocity is decreased by MaxDeceleration.(0.9)
If the target velocity is smaller than the velocity of the target vehicle then the target velocity is increased by MaxAcceleration(0.95)
Otherwise the target velocity does not change.

ChangeLaneToRight and ChangeLaneToLeft:
In case of a lane change the target velocity shall not change (no acceleration or decelaration during the lane change). The trajectory is generated in a similar way as for the follow lane case, but the 3 new points given to the spline (the ones which are not coming from the previous path points) are located in the target lane and the new point are in distance of 60, 120 and 180 meters instead of 30, 60 and 90 in order to have a smooth and comfortable lane change.
